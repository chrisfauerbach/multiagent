{% extends "base.html" %}
{% block title %}Stories - AI Publishing House{% endblock %}
{% block content %}
<h1>Stories</h1>

<div class="filters">
    <a href="/stories" class="btn {% if not current_status %}btn-active{% endif %}">All</a>
    {% for status in ["QUEUED", "PROMPT_CREATED", "DRAFT_WRITTEN", "IN_REVIEW", "REVISION_NEEDED", "REVISED", "APPROVED", "DESIGNING_COVER", "PUBLISHED"] %}
    <a href="/stories?status={{ status }}" class="btn {% if current_status == status %}btn-active{% endif %}">
        {{ status.replace("_", " ") }}
    </a>
    {% endfor %}
</div>

{% if stories %}
<div id="pdf-toolbar" class="pdf-toolbar hidden">
    <span id="pdf-count">0 selected</span>
    <button class="btn btn-primary" onclick="downloadSelected()">Download PDF</button>
</div>
<table class="data-table">
    <thead>
        <tr>
            <th class="col-check"><input type="checkbox" id="select-all" onchange="toggleAll(this)"></th>
            <th>ID</th>
            <th>Title</th>
            <th>Genre / Theme</th>
            <th>Model</th>
            <th>Status</th>
            <th>Revisions</th>
            <th>Created</th>
        </tr>
    </thead>
    <tbody>
        {% for s in stories %}
        <tr>
            <td class="col-check">
                {% if s.current_draft %}
                <input type="checkbox" class="story-check" value="{{ s.story_id }}" onchange="updateToolbar()">
                {% endif %}
            </td>
            <td><a href="/stories/{{ s.story_id }}">{{ s.story_id }}</a></td>
            <td>{{ s.title or "Untitled" }}</td>
            <td>
                {% if s.prompt %}
                <span class="tag tag-genre">{{ s.prompt.genre.replace("_", " ") }}</span>
                {% if s.prompt.theme %}<span class="tag tag-theme">{{ s.prompt.theme }}</span>{% endif %}
                {% else %}—{% endif %}
            </td>
            <td class="detail-cell">{{ s.model or "—" }}</td>
            <td><span class="badge badge-{{ s.status.value | lower }}">{{ s.status.value }}</span></td>
            <td>{{ s.revision_count }}</td>
            <td>{{ s.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<script>
function toggleAll(master) {
    document.querySelectorAll(".story-check").forEach(function(cb) { cb.checked = master.checked; });
    updateToolbar();
}
function updateToolbar() {
    var checked = document.querySelectorAll(".story-check:checked");
    var toolbar = document.getElementById("pdf-toolbar");
    var count = document.getElementById("pdf-count");
    if (checked.length > 0) {
        toolbar.classList.remove("hidden");
        count.textContent = checked.length + " selected";
    } else {
        toolbar.classList.add("hidden");
    }
}
function downloadSelected() {
    var ids = Array.from(document.querySelectorAll(".story-check:checked")).map(function(cb) { return cb.value; });
    if (ids.length === 0) return;
    var params = ids.map(function(id) { return "ids=" + encodeURIComponent(id); }).join("&");
    window.location.href = "/api/stories/pdf?" + params;
}
</script>
{% else %}
<p class="empty-state">No stories found.</p>
{% endif %}
{% endblock %}
